# Description:
#   千葉県の2日分の天気予報を表示
#
# Notes:
#   "天気予報"と発言する

parser = require 'json-parser'
request = require 'request'

window = this

request
  # "120010"は千葉県
  url: 'http://weather.livedoor.com/forecast/webservice/json/v1?city=120010'
, (err, response, body) ->
  throw err if err  # 接続エラーなどが発生した場合
  if response.statusCode is 200  # ステータスコードが「OK」の場合
    result = parser.parse(body)

    #console.log result
    window.pref = result['title']
    window.comment = result['description']['text']

    for key,val of result['forecasts']
      if val['dateLabel'] is '今日'
       window.today = "今日 : #{val['telop']}"
      if val['dateLabel'] is '明日'
       window.tommorow = "明日 : #{val['telop']}"

  else
    console.log "response error: #{response.statusCode}"


module.exports = (robot) ->
    robot.hear /天気予報/, (msg) ->
        msg.send window.pref
        msg.send window.today
        msg.send window.tommorow
        msg.send "-------------------------"
        msg.send window.comment
